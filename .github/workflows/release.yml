name: Release Build Tools

on:
  push:
    tags:
      - '[0-9]+.[0-9]+.[0-9]+'

jobs:
  release:
    runs-on: ubuntu-latest
    permissions:
      contents: read

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Set up Java 21
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'

      - name: Set up Node (Public NPM)
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          registry-url: 'https://registry.npmjs.org'
          scope: '@meiji-academy'

      - name: Extract Version from Tag
        id: get_version
        shell: bash
        run: echo "VERSION=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT

      - name: Check Gradle Plugin Version
        id: check_gradle
        env:
          PLUGIN_ID: "com.meijiacademy.build.tools"
          VERSION: ${{ steps.get_version.outputs.VERSION }}
        run: |
          echo "Checking if $PLUGIN_ID version $VERSION exists..."
          URL="https://plugins.gradle.org/plugin/$PLUGIN_ID/$VERSION"
          
          HTTP_STATUS=$(curl -o /dev/null -s -L -w "%{http_code}\n" "$URL")
          
          if [ "$HTTP_STATUS" == "200" ]; then
             echo "âœ… Version $VERSION already exists on Gradle Portal."
             echo "PUBLISH_NEEDED=false" >> $GITHUB_OUTPUT
          else
             echo "ðŸš€ Version $VERSION not found. Publishing..."
             echo "PUBLISH_NEEDED=true" >> $GITHUB_OUTPUT
          fi

      - name: Publish Gradle Plugin
        if: steps.check_gradle.outputs.PUBLISH_NEEDED == 'true'
        working-directory: ./gradle-plugin
        env:
          PROJECT_VERSION: ${{ steps.get_version.outputs.VERSION }}
          GRADLE_PUBLISH_KEY: ${{ secrets.GRADLE_PUBLISH_KEY }}
          GRADLE_PUBLISH_SECRET: ${{ secrets.GRADLE_PUBLISH_SECRET }}
        run: |
          chmod +x gradlew
          ./gradlew publishPlugins

      - name: Check NPM Version
        id: check_npm
        working-directory: ./npm-utils
        env:
          VERSION: ${{ steps.get_version.outputs.VERSION }}
        run: |
          PACKAGE_NAME=$(node -p "require('./package.json').name")
          echo "Checking npmjs.org for $PACKAGE_NAME @ $VERSION"
          
          PUBLISHED_VERSION=$(npm view "$PACKAGE_NAME@$VERSION" version 2>/dev/null || echo "not_found")
          
          if [ "$PUBLISHED_VERSION" == "$VERSION" ]; then
            echo "âœ… Version $VERSION already exists on NPM."
            echo "PUBLISH_NEEDED=false" >> $GITHUB_OUTPUT
          else
            echo "ðŸš€ Version $VERSION not found. Publishing..."
            echo "PUBLISH_NEEDED=true" >> $GITHUB_OUTPUT
          fi

      - name: Publish NPM Utils
        if: steps.check_npm.outputs.PUBLISH_NEEDED == 'true'
        working-directory: ./npm-utils
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}
        run: |
          npm version ${{ steps.get_version.outputs.VERSION }} --no-git-tag-version --allow-same-version
          
          npm install
          npm publish --access public